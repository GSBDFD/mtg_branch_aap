<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIä¼šè©±ãƒ–ãƒ©ãƒ³ãƒå¯è¦–åŒ–ãƒ„ãƒ¼ãƒ«</title>
    
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    
    <style>
        body { font-family: sans-serif; margin: 20px; background-color: #f4f7f6; }
        h1 { color: #2c3e50; text-align: center; }
        .controls { 
            display: flex; 
            gap: 10px; 
            justify-content: center; 
            margin-bottom: 20px; 
            padding: 15px; 
            background-color: #e9ecef; 
            border-radius: 8px; 
        }
        .controls button { 
            padding: 10px 18px; 
            font-size: 1rem; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            background-color: #007bff; 
            color: white; 
            transition: background-color 0.2s;
        }
        .controls button:hover { background-color: #0056b3; }
        #mermaid-container {
            margin: 30px auto;
            border: 1px solid #ccc;
            background-color: #fff;
            padding: 20px;
            overflow-x: auto;
            min-height: 400px; /* æç”»ã‚¨ãƒªã‚¢ç¢ºä¿ */
        }
        #status-display {
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>AIä¼šè©±ãƒ–ãƒ©ãƒ³ãƒ ãƒŠãƒ“ã‚²ãƒ¼ã‚¿ãƒ¼</h1>

    <div id="status-display">æ¥ç¶šä¸­...</div>
    <div id="current-branch-display" style="text-align: center; font-size: 1.2rem; margin-bottom: 15px; font-weight: bold; color: #2980b9;">
        ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: main
    </div>

    <div class="controls">
        <input type="text" id="talkInput" placeholder="ç™ºè¨€å†…å®¹ã‚’å…¥åŠ› (talk)">
        <button onclick="sendUserAction('talk')">ç™ºè¨€é€ä¿¡</button>
        <button onclick="sendUserAction('branch')">è©±é¡Œåˆ†å² (branch)</button>
        <button onclick="sendUserAction('merge')">å…ƒã«æˆ»ã‚‹ (merge)</button>
        <button onclick="resetGraph()">ãƒªã‚»ãƒƒãƒˆ (æ‰‹å‹•)</button>
    </div>

    <div id="mermaid-container">
        <div class="mermaid" id="gitGraphDisplay"></div>
    </div>

    <script>
        // --- 1. WebSocket æ¥ç¶šè¨­å®š ---
        
        // ğŸš¨ ã‚µãƒ¼ãƒãƒ¼ãŒãƒãƒ¼ãƒˆ8002ã§èµ·å‹•ã—ã¦ã„ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹
        const SERVER_URL = "ws://127.0.0.1:8002/ws";
        const ws = new WebSocket(SERVER_URL);
        const statusDisplay = document.getElementById('status-display');
        const talkInput = document.getElementById('talkInput');
        const currentBranchDisplay = document.getElementById('current-branch-display');
        
        // --- 2. Mermaid & ã‚°ãƒ©ãƒ•çŠ¶æ…‹ç®¡ç† ---
        
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            git: {
                mainBranchName: 'main',
                showBranches: true,
                showCommitLabel: true
            }
        });

        let mermaidCode = 'gitGraph\n\tcommit id: "ä¼šè­°é–‹å§‹"';
        let currentBranchName = 'main';
        let branchStack = ['main'];
        let branchCounter = 0;

        const displayElement = document.getElementById('gitGraphDisplay');

        /**
        * ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒåã‚’UIã«è¡¨ç¤ºã™ã‚‹
        */
        function updateBranchDisplay() {
            currentBranchDisplay.textContent = `ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒ: ${currentBranchName}`;
        }

        /**
         * ã‚°ãƒ©ãƒ•ã‚’Mermaidè¨˜æ³•ã«åŸºã¥ã„ã¦å†æç”»ã™ã‚‹
         */
        function updateGraph() {
            displayElement.textContent = mermaidCode;

            mermaid.render('mermaid-chart', mermaidCode)
                .then(({ svg }) => {
                    displayElement.innerHTML = svg;
                })
                .catch(err => {
                    displayElement.innerHTML = `<p style="color:red;">ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒ©ãƒ¼: ${err.message}</p>`;
                });
        }
        
        // --- 3. WebSocket ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ ---

        ws.onopen = function(event) {
            statusDisplay.textContent = "âœ… æ¥ç¶šå®Œäº†";
            statusDisplay.style.color = "green";
            console.log("WebSocketæ¥ç¶šãŒç¢ºç«‹ã•ã‚Œã¾ã—ãŸã€‚");
            ws.send("ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰æ¥ç¶šã—ã¾ã—ãŸã€‚");
            updateGraph(); // åˆæœŸã‚°ãƒ©ãƒ•æç”»
        };

        ws.onmessage = function(event) {
            console.log("ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰AIã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡:", event.data);
            
            try {
                const aiCommand = JSON.parse(event.data);
                
                // å—ä¿¡ã—ãŸAIã‚³ãƒãƒ³ãƒ‰ã‚’å‡¦ç†ã—ã€ã‚°ãƒ©ãƒ•ã‚’æ›´æ–°
                handleAICommand(aiCommand);
                
            } catch (e) {
                console.error("JSONãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:", e);
            }
        };

        ws.onclose = function(event) {
            statusDisplay.textContent = "âŒ æ¥ç¶šåˆ‡æ–­";
            statusDisplay.style.color = "red";
            console.log("WebSocketæ¥ç¶šãŒé–‰ã˜ã‚‰ã‚Œã¾ã—ãŸã€‚");
        };

        ws.onerror = function(event) {
            statusDisplay.textContent = "âš ï¸ æ¥ç¶šã‚¨ãƒ©ãƒ¼";
            statusDisplay.style.color = "orange";
            console.error("WebSocketã‚¨ãƒ©ãƒ¼:", event);
        };

        // --- 4. ã‚°ãƒ©ãƒ•æ›´æ–°ãƒ­ã‚¸ãƒƒã‚¯ (AIã‚³ãƒãƒ³ãƒ‰å‡¦ç†) ---

        /**
         * AIã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒãƒ³ãƒ‰ã«åŸºã¥ã„ã¦ã‚°ãƒ©ãƒ•ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
         * @param {object} command - {"action": "talk"|"branch"|"merge", ...}
         */
        /**
         * AIã‹ã‚‰å—ã‘å–ã£ãŸã‚³ãƒãƒ³ãƒ‰ã«åŸºã¥ã„ã¦ã‚°ãƒ©ãƒ•ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹
         * @param {object} command - {"action": "talk"|"branch"|"merge", ...}
         */
        function handleAICommand(command) {
            const { action, topic, text } = command;
            
            // ğŸ’¡ ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆ: 
            // ç¾åœ¨æ™‚åˆ»(ãƒŸãƒªç§’)ã‚’å–å¾—ã—ã€ã‚³ãƒŸãƒƒãƒˆIDã‚’å¼·åˆ¶çš„ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯ã«ã™ã‚‹
            const uniqueId = Date.now(); 

            switch (action) {
                case 'talk':
                    // ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’æ˜ç¤º
                    mermaidCode += `\n\tcheckout ${currentBranchName}`; 
                    // ğŸ’¡ IDã« uniqueId ã‚’ä»˜ä¸ (è¡¨ç¤ºã¯ã•ã‚Œã¾ã›ã‚“ãŒã€å†…éƒ¨IDã¨ã—ã¦æ©Ÿèƒ½ã—ã¾ã™)
                    mermaidCode += `\n\tcommit id: "${text} - ${uniqueId}" tag: "${text}"`;
                    break;

                case 'branch':
                    // æ·±ã•åˆ¶é™ï¼ˆã“ã‚Œã¯ stack.length ã§åˆ¤å®šã—ã¦OKï¼‰
                    if (branchStack.length >= 5) {
                        alert("ãƒ–ãƒ©ãƒ³ãƒãŒæ·±ã™ãã¾ã™ã€‚");
                        return;
                    }

                    // ğŸ’¡ ä¿®æ­£: ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å¢—ã‚„ã—ã¦ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªãƒ–ãƒ©ãƒ³ãƒåã‚’ä½œã‚‹
                    branchCounter++; 
                    const newBranchName = 'sub-' + branchCounter; 
                    
                    // ä»¥ä¸‹ã¯å¤‰æ›´ãªã—
                    mermaidCode += `\n\tbranch ${newBranchName}`;
                    mermaidCode += `\n\tcheckout ${newBranchName}`;
                    
                    // ã‚³ãƒŸãƒƒãƒˆIDã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã‚‚ãŠå¿˜ã‚Œãªã
                    mermaidCode += `\n\tcommit id: "${topic || 'åˆ†å²'} - ${uniqueId}" tag: "${topic || 'åˆ†å²'}"`;
                    
                    branchStack.push(newBranchName);
                    currentBranchName = newBranchName;
                    break;

                case 'merge':
                    if (branchStack.length <= 1) {
                        console.log("ãƒ¡ã‚¤ãƒ³ãƒ–ãƒ©ãƒ³ãƒã®ãŸã‚ãƒãƒ¼ã‚¸ã¯ã‚¹ã‚­ãƒƒãƒ—ã€‚");
                        return;
                    } 
                    
                    const branchToMerge = branchStack.pop(); // ãƒãƒ¼ã‚¸å…ƒ
                    const targetBranch = branchStack[branchStack.length - 1]; // ãƒãƒ¼ã‚¸å…ˆï¼ˆè¦ªï¼‰
                    
                    // 1. è¦ªãƒ–ãƒ©ãƒ³ãƒã«æˆ»ã‚‹
                    mermaidCode += `\n\tcheckout ${targetBranch}`;
                    
                    // 2. ãƒãƒ¼ã‚¸å®Ÿè¡Œ (ğŸ’¡ã“ã“ã‚‚ãƒ¦ãƒ‹ãƒ¼ã‚¯IDåŒ–)
                    mermaidCode += `\n\tmerge ${branchToMerge} id: "merge-${uniqueId}" tag: "åˆæµ"`;
                    
                    // 3. æ“ä½œãƒ–ãƒ©ãƒ³ãƒã‚’è¦ªã«æˆ»ã™
                    currentBranchName = targetBranch;
                    
                    // 4. å¿µã®ãŸã‚ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚’æ˜è¨˜ï¼ˆè§£æ±ºç­–1ã®å†…å®¹ï¼‰
                    mermaidCode += `\n\tcheckout ${currentBranchName}`;
                    break;
                
                case 'end':
                    break;
            }

            updateGraph();
        }

        // --- 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ (WebSocketé€ä¿¡) ---
        
        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
         */
        // index.html ã® sendUserAction é–¢æ•°

function sendUserAction(actionType) {
    if (ws.readyState !== WebSocket.OPEN) {
        alert("ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
    }

    let message = talkInput.value.trim() || "";
    
    let payload = {};

    if (actionType === 'talk') {
        if (!message) {
            alert("ç™ºè¨€å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
            return;
        }
        payload = { action: 'talk', content: message };
    } else if (actionType === 'branch') {
        // ğŸ’¡ ä¿®æ­£ç‚¹ï¼šbranchã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ã‚µãƒ¼ãƒãƒ¼ã«æ˜ç¤º
        payload = { action: 'branch', content: message || 'æ–°ã—ã„è©±é¡Œ' };
    } else if (actionType === 'merge') {
        // ğŸ’¡ ä¿®æ­£ç‚¹ï¼šmergeã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ã“ã¨ã‚’ã‚µãƒ¼ãƒãƒ¼ã«æ˜ç¤º
        payload = { action: 'merge' };
    } else {
        return;
    }

    // ã‚µãƒ¼ãƒãƒ¼ã«ã¯JSONæ–‡å­—åˆ—ã¨ã—ã¦é€ä¿¡ã™ã‚‹ (JSON.stringifyã‚’ä½¿ç”¨)
    ws.send(JSON.stringify(payload));
    
    // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
    if (actionType === 'talk' || actionType === 'branch') {
        talkInput.value = '';
    }
}

        /**
         * ã‚°ãƒ©ãƒ•ã¨çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹
         */
        function resetGraph() {
            if (confirm("ã‚°ãƒ©ãƒ•ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) {
                mermaidCode = 'gitGraph\n\tcommit id: "ä¼šè­°é–‹å§‹"';
                currentBranchName = 'main';
                branchStack = ['main'];
                updateGraph();
                statusDisplay.textContent = "âœ… æ¥ç¶šå®Œäº† (ã‚°ãƒ©ãƒ•ãƒªã‚»ãƒƒãƒˆ)";
                statusDisplay.style.color = "green";
            }
        }

    </script>
</body>
</html>